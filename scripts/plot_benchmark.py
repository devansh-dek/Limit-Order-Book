#!/usr/bin/env python3
"""
Benchmark visualization script for EfficientLimitOrderBook.
Plots throughput and other metrics from benchmark CSV output.
"""

import pandas as pd
import matplotlib.pyplot as plt
import argparse
from pathlib import Path


def load_benchmark_csv(csv_path):
    """Load benchmark CSV file."""
    df = pd.read_csv(csv_path)
    return df


def plot_throughput_by_scenario(df, output_dir=None):
    """Plot throughput (ops/sec) grouped by scenario and N."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    scenarios = df['scenario'].unique()
    ns = sorted(df['N'].unique())
    
    x = range(len(ns))
    width = 0.25
    
    for i, scenario in enumerate(sorted(scenarios)):
        scenario_data = df[df['scenario'] == scenario]
        # Sort by N to ensure consistent ordering
        scenario_data = scenario_data.sort_values('N')
        throughputs = scenario_data['throughput_ops_s'].values
        offset = (i - len(scenarios)/2 + 0.5) * width
        ax.bar([xi + offset for xi in x], throughputs, width, label=scenario)
    
    ax.set_xlabel('Number of Orders (N)', fontsize=12)
    ax.set_ylabel('Throughput (ops/sec)', fontsize=12)
    ax.set_title('Matching Engine Throughput by Scenario', fontsize=14, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels([str(n) for n in ns])
    ax.legend()
    ax.grid(axis='y', alpha=0.3)
    
    plt.tight_layout()
    if output_dir:
        output_path = Path(output_dir) / 'throughput_by_scenario.png'
        fig.savefig(output_path, dpi=150)
        print(f"Saved: {output_path}")
    else:
        plt.show()


def plot_throughput_scaling(df, output_dir=None):
    """Plot throughput scaling with respect to N for each scenario."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    scenarios = sorted(df['scenario'].unique())
    colors = ['#1f77b4', '#ff7f0e', '#2ca02c']
    
    for scenario, color in zip(scenarios, colors):
        scenario_data = df[df['scenario'] == scenario].sort_values('N')
        ax.plot(scenario_data['N'], scenario_data['throughput_ops_s'], 
                marker='o', linewidth=2, markersize=8, label=scenario, color=color)
    
    ax.set_xlabel('Number of Orders (N)', fontsize=12)
    ax.set_ylabel('Throughput (ops/sec)', fontsize=12)
    ax.set_title('Throughput Scaling Across Order Counts', fontsize=14, fontweight='bold')
    ax.legend(fontsize=11)
    ax.grid(True, alpha=0.3)
    
    # Format y-axis as thousands
    ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{int(x/1000)}K'))
    
    plt.tight_layout()
    if output_dir:
        output_path = Path(output_dir) / 'throughput_scaling.png'
        fig.savefig(output_path, dpi=150)
        print(f"Saved: {output_path}")
    else:
        plt.show()


def plot_execution_time(df, output_dir=None):
    """Plot execution time (seconds) for each scenario and N."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    scenarios = df['scenario'].unique()
    ns = sorted(df['N'].unique())
    
    x = range(len(ns))
    width = 0.25
    
    for i, scenario in enumerate(sorted(scenarios)):
        scenario_data = df[df['scenario'] == scenario].sort_values('N')
        times_ms = scenario_data['seconds'].values * 1000  # Convert to milliseconds
        offset = (i - len(scenarios)/2 + 0.5) * width
        ax.bar([xi + offset for xi in x], times_ms, width, label=scenario)
    
    ax.set_xlabel('Number of Orders (N)', fontsize=12)
    ax.set_ylabel('Execution Time (ms)', fontsize=12)
    ax.set_title('Matching Engine Execution Time by Scenario', fontsize=14, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels([str(n) for n in ns])
    ax.legend()
    ax.grid(axis='y', alpha=0.3)
    
    plt.tight_layout()
    if output_dir:
        output_path = Path(output_dir) / 'execution_time.png'
        fig.savefig(output_path, dpi=150)
        print(f"Saved: {output_path}")
    else:
        plt.show()


def plot_trade_generation(df, output_dir=None):
    """Plot number of trades generated per scenario."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    scenarios = df['scenario'].unique()
    ns = sorted(df['N'].unique())
    
    x = range(len(ns))
    width = 0.25
    
    for i, scenario in enumerate(sorted(scenarios)):
        scenario_data = df[df['scenario'] == scenario].sort_values('N')
        trades = scenario_data['trades'].values
        offset = (i - len(scenarios)/2 + 0.5) * width
        ax.bar([xi + offset for xi in x], trades, width, label=scenario)
    
    ax.set_xlabel('Number of Orders (N)', fontsize=12)
    ax.set_ylabel('Number of Trades', fontsize=12)
    ax.set_title('Trades Generated by Scenario', fontsize=14, fontweight='bold')
    ax.set_xticks(x)
    ax.set_xticklabels([str(n) for n in ns])
    ax.legend()
    ax.grid(axis='y', alpha=0.3)
    
    plt.tight_layout()
    if output_dir:
        output_path = Path(output_dir) / 'trades_generated.png'
        fig.savefig(output_path, dpi=150)
        print(f"Saved: {output_path}")
    else:
        plt.show()


def main():
    parser = argparse.ArgumentParser(
        description='Plot EfficientLimitOrderBook benchmark results'
    )
    parser.add_argument(
        'csv_file',
        nargs='?',
        default='bench_results.csv',
        help='Path to benchmark CSV file (default: bench_results.csv)'
    )
    parser.add_argument(
        '-o', '--output',
        help='Output directory for PNG files (if not specified, display plots)',
        type=str
    )
    parser.add_argument(
        '--all',
        action='store_true',
        help='Generate all plots (default)'
    )
    
    args = parser.parse_args()
    
    # Load CSV
    csv_path = Path(args.csv_file)
    if not csv_path.exists():
        print(f"Error: {csv_path} not found")
        exit(1)
    
    df = load_benchmark_csv(csv_path)
    print(f"Loaded {len(df)} benchmark rows from {csv_path}")
    
    # Create output directory if needed
    output_dir = None
    if args.output:
        output_dir = Path(args.output)
        output_dir.mkdir(parents=True, exist_ok=True)
    
    # Generate plots
    print("Generating plots...")
    plot_throughput_by_scenario(df, output_dir)
    plot_throughput_scaling(df, output_dir)
    plot_execution_time(df, output_dir)
    plot_trade_generation(df, output_dir)
    
    if output_dir:
        print(f"\nAll plots saved to {output_dir}/")
    else:
        plt.show()


if __name__ == '__main__':
    main()
